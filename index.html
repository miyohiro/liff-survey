<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ジョブコミット事前アンケート</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; background-color: #f8f9fa; }
    .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    h2 { text-align: center; color: #333; }
    .field { margin-bottom: 15px; }
    label { display: block; font-weight: bold; margin-bottom: 5px; }
    input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
    button { width: 100%; padding: 12px; background: #00b900; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; }
    button:disabled { background: #ccc; }
    #loading { display: none; text-align: center; margin-top: 10px; color: #666; }
  </style>
</head>
<body>

<div class="container">
  <h2>事前アンケート</h2>
  <form id="survey-form">
    <input type="hidden" id="userId" name="userId">

    <div class="field">
      <label>お名前</label>
      <input type="text" id="name" required placeholder="山田 太郎">
    </div>

    <div class="field">
      <label>フリガナ</label>
      <input type="text" id="furigana" required placeholder="ヤマダ タロウ">
    </div>

    <div class="field">
      <label>大学名</label>
      <input type="text" id="university" required>
    </div>

    <div class="field">
      <label>学部・学科</label>
      <input type="text" id="gakubu" placeholder="経済学部" required style="width: 48%; display: inline-block;">
      <input type="text" id="gakka" placeholder="経済学科" required style="width: 48%; display: inline-block; margin-left: 2%;">
    </div>

    <div class="field">
      <label>メールアドレス</label>
      <input type="email" id="email" required>
    </div>

    <div class="field">
      <label>電話番号</label>
      <input type="tel" id="tel" required>
    </div>

    <div class="field">
      <label>卒業年</label>
      <select id="sotsunen" required>
        <option value="">選択してください</option>
        <option value="2025">2025卒</option>
        <option value="2026">2026卒</option>
        <option value="2027">2027卒</option>
        <option value="その他">その他</option>
      </select>
    </div>

    <button type="button" id="submitBtn" onclick="handleSubmit()">回答を送信する</button>
    <div id="loading">送信中...</div>
  </form>
</div>

<script>
  // ★重要：あなたのGASのウェブアプリURLをここに貼る
  const GAS_URL = "https://script.google.com/macros/s/AKfycbxCoaZv0gx_rLeI4HhwTCeQF4gNRQd1YetwifrPLW97zVRx7UTpQDTDuoallx2aCshi/exec"; 
  // ★重要：あなたのLIFF ID（LINE Developersで作成）をここに貼る
  const MY_LIFF_ID = "2008904530-lXx8C9i5"; 

  // LIFFの初期化
  window.onload = function() {
    liff.init({ liffId: MY_LIFF_ID })
      .then(() => {
        if (!liff.isLoggedIn()) {
          liff.login();
        } else {
          // ログイン済みならユーザーIDを取得して隠しフィールドに入れる
          const context = liff.getContext();
          if (context && context.userId) {
            document.getElementById('userId').value = context.userId;
          }
        }
      })
      .catch((err) => { console.error("LIFF初期化失敗", err); });
  };

  // 送信処理
  async function handleSubmit() {
    const submitBtn = document.getElementById('submitBtn');
    const loading = document.getElementById('loading');
    
    // 入力チェック（簡易版）
    const name = document.getElementById('name').value;
    if (!name) { alert("お名前を入力してください"); return; }

    submitBtn.disabled = true;
    loading.style.display = "block";

    const data = {
      userId: document.getElementById('userId').value,
      name: name,
      furigana: document.getElementById('furigana').value,
      university: document.getElementById('university').value,
      gakubu: document.getElementById('gakubu').value,
      gakka: document.getElementById('gakka').value,
      email: document.getElementById('email').value,
      tel: document.getElementById('tel').value,
      sotsunen: document.getElementById('sotsunen').value
    };

    try {
      // GASへ送信
      await fetch(GAS_URL, {
        method: "POST",
        mode: "no-cors", // GASへのPOSTはこの設定が必要
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      // LINEトーク画面にメッセージを送る
      // これにより、GAS側の doPost 内の「アンケートの回答を送信しました」判定が動く
      await liff.sendMessages([{
        type: 'text',
        text: 'アンケートの回答を送信しました'
      }]);

      alert("送信完了しました！");
      liff.closeWindow();

    } catch (error) {
      console.error(error);
      alert("エラーが発生しました。もう一度お試しください。");
      submitBtn.disabled = false;
      loading.style.display = "none";
    }
  }
</script>

</body>
</html>
