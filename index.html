<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ジョブコミット事前アンケート</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; background-color: #f8f9fa; line-height: 1.6; }
    .container { max-width: 500px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    h2 { text-align: center; color: #333; margin-bottom: 20px; }
    .field { margin-bottom: 15px; }
    label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
    input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
    button { width: 100%; padding: 14px; background: #00b900; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    #loading { display: none; text-align: center; margin-top: 15px; color: #00b900; font-weight: bold; }
  </style>
</head>
<body>

<div class="container">
  <h2>事前アンケート</h2>
  <form id="survey-form">
    <input type="hidden" id="userId" name="userId">

    <div class="field">
      <label>お名前</label>
      <input type="text" id="name" required placeholder="山田 太郎">
    </div>

    <div class="field">
      <label>フリガナ</label>
      <input type="text" id="furigana" required placeholder="ヤマダ タロウ">
    </div>

    <div class="field">
      <label>大学名</label>
      <input type="text" id="university" required placeholder="〇〇大学">
    </div>

    <div class="field">
      <label>学部・学科</label>
      <div style="display: flex; gap: 10px;">
        <input type="text" id="gakubu" placeholder="経済学部" required>
        <input type="text" id="gakka" placeholder="経済学科" required>
      </div>
    </div>

    <div class="field">
      <label>メールアドレス</label>
      <input type="email" id="email" required placeholder="example@mail.com">
    </div>

    <div class="field">
      <label>電話番号</label>
      <input type="tel" id="tel" required placeholder="09012345678">
    </div>

    <div class="field">
      <label>卒業年</label>
      <select id="sotsunen" required>
        <option value="">選択してください</option>
        <option value="2026">2026卒</option>
        <option value="2027">2027卒</option>
        <option value="その他">その他</option>
      </select>
    </div>

    <button type="button" id="submitBtn" onclick="handleSubmit()">回答を送信する</button>
    <div id="loading">送信中... しばらくお待ちください</div>
  </form>
</div>

<script>
  // ★重要1：最新のGASウェブアプリURLをここに貼る
  const GAS_URL = "https://script.google.com/macros/s/AKfycbwaBCK6fR_OOMFxMdEs9Axh_TLpLk_3tp7jLZKzTYmPJSv5nmA8t8ewwoXSIZ579GA/exec"; 
  // ★重要2：LINE DevelopersのLIFF IDをここに貼る
  const MY_LIFF_ID = "2008904530-lXx8C9i5"; 

  // LIFF初期化
  window.onload = function() {
    liff.init({ liffId: MY_LIFF_ID })
      .then(() => {
        if (!liff.isLoggedIn()) {
          liff.login();
        } else {
          const context = liff.getContext();
          if (context && context.userId) {
            document.getElementById('userId').value = context.userId;
          }
        }
      })
      .catch((err) => { console.error("LIFF初期化失敗", err); });
  };

  // 送信ボタンクリック時の処理
  async function handleSubmit() {
    const submitBtn = document.getElementById('submitBtn');
    const loading = document.getElementById('loading');
    
    // 必須項目チェック
    const name = document.getElementById('name').value;
    const userId = document.getElementById('userId').value;
    if (!name) { alert("お名前を入力してください"); return; }
    if (!userId) { alert("LINE IDが取得できませんでした。再度開いてください。"); return; }

    submitBtn.disabled = true;
    loading.style.display = "block";

    const data = {
      userId: userId,
      name: name,
      furigana: document.getElementById('furigana').value,
      university: document.getElementById('university').value,
      gakubu: document.getElementById('gakubu').value,
      gakka: document.getElementById('gakka').value,
      email: document.getElementById('email').value,
      tel: document.getElementById('tel').value,
      sotsunen: document.getElementById('sotsunen').value
    };

    try {
      // GASへデータ送信
      await fetch(GAS_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      // LINEにメッセージを自動投稿（これで日程調整が起動する）
      await liff.sendMessages([{
        type: 'text',
        text: 'アンケートの回答を送信しました'
      }]);

      alert("送信完了しました！");
      liff.closeWindow();

    } catch (error) {
      console.error(error);
      alert("通信エラーが発生しました。");
      submitBtn.disabled = false;
      loading.style.display = "none";
    }
  }
</script>

</body>
</html>
